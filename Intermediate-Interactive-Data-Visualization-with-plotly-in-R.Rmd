## Intermediate Plotly {.unnumbered}

<h3 class="course__description-title">Adam Loy</h3>
<p class="course__instructor-description display-none-mobile-course-page-experiment">
    Adam is an assistant professor of statistics at Carleton College where he teaches courses in statistics in data science. His research interests lie in statistical graphics and computing, R development, and statistics/data science education. Find out more on Adam's <a href="https://aloy.rbind.io/">webpage</a>.
  </p>

**Course Description**

<p class="course__description">The plotly package enables the construction of interactive and animated graphics entirely within R. This goes beyond basic interactivity such as panning, zooming, and tooltips. In this course, you will extend your understanding of plotly to create animated and linked interactive graphics, which will enable you to communicate multivariate stories quickly and effectively. Along the way, you will review the basics of plotly, learn how to wrangle your data in new ways to facilitate cumulative animations, and learn how to add filters to your graphics without using Shiny.</p>

### Review of plotly {.unnumbered}

<p class="chapter__description">
    A review of key plotly commands. You will review how to create multiple plot types in plotly and how to polish your charts. Additionally, you will create static versions of the bubble and line charts that you will animate in the next chapter.
  </p>

#### Interactive graphics {.unnumbered}

##### Which is the interactive graphic? {.unnumbered}

<div class=""><p>When you are designing graphics, you need to carefully consider what type of graphic best suits your needs: a static graphic, and interactive graphic, or a dynamic graphic.</p>
<p>Four example graphics are described below, identify the interactive graphic.</p></div>

- [ ] A scatterplot of the average broadband speed against average cost by country, facetted by year.
- [x] A scatterplot of the average broadband speed against average cost by country with a dropdown menu to select the year displayed.
- [ ] An animated scatterplot of the average broadband speed against average cost by country over the years.
- [ ] A scatterplot of the average broadband speed against average cost by country that is automatically updated when new data become available.

<p class="dc-completion-pane__message dc-u-maxw-100pc">Correct! This graphic responds to the year selected by the user, making it an interactive graphic.</p>

##### A simple time series plot {.unnumbered}


<div class>
<p>Your task is to create an interactive time series plot of the opening price of the MSCI All Country World Index, instead of the closing price previously plotted.</p>
<p>Remember that the <code>msci</code> data set contains daily information on the trading price of the <a href="https://www.ishares.com/us/products/239600/ishares-msci-acwi-etf#/">iShares MSCI All Country World Index ETF</a> including:</p>

<li>
<code>Date</code>: the date</li>
<li>
<code>Open</code>: opening price</li>
<li>
<code>High</code>: high price</li>
<li>
<code>Low</code>: low price</li>
<li>
<code>Close</code>: closing price</li>
<li>
<code>Volume</code>: number of tradesË™</li>
<li>
<code>Adjusted</code>: adjusted closing price</li>

<p>After you create the plot, play around with it! Explore the ways that you can interact with plots in plotly, such as "Pan", "Zoom", and "Toggle Spike Lines".</p>
</div>

```{r}
# edited/added
acwi = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSD8eHTP8ohmRzaYNWI4EHx2AwhgRS_SZEPKjoulvvptc2yKXg0arsVsgkAX9c2Ef3t_v65Gl_ixq3P/pub?gid=0&single=true&output=csv")
```
<li>Load the <code>plotly</code> package.</li>
<li>Fill in the code to create an interactive time series plot with <code>Open</code> on the y-axis and <code>Date</code> on the x-axis.</li>
```{r}
# load the plotly package
library(plotly)

# Change the code below to create a times series plot of Open
acwi %>% 
    plot_ly(x = ~Date, y = ~Open) %>%
    add_lines()
```

<p class="">Well done! Now that you have reviewed how to map variables from your data set to aesthetic parameters, let's review another type of plot.
</p>

##### A simple scatterplot {.unnumbered}


<div class>
<p>Now that you have created a time series plot, your task is to create an interactive scatterplot of the trading volume against the date.</p>
<p>The <code>plotly</code> package and <code>acwi</code> data set have already been loaded for you.</p>
</div>


<li>Create a scatterplot of the trading <code>Volume</code> (on the y-axis) against the <code>Date</code> (on the x-axis).</li>
```{r}
# Create a scatterplot with Date on the x-axis 
# and Volume on the y-axis
acwi %>%
  plot_ly(x = ~Date, y = ~Volume) %>%
  add_markers()
```

<p class="">Great job! Using the <code>plot_ly()</code> function in combination with an <code>add_*()</code> trace allows us to create a wide range of graphics.
</p>

#### Adding aesthetics {.unnumbered}



##### Color and size {.unnumbered}


<div class>
<p>In this example, you will continue exploring the <a href="http://worldhappiness.report/">World Happiness Report</a> data set. So far you have explored how the relationship between happiness and life expectancy is mediated by income class and population. Your task is to explore how the region of the world mediates this relationship.</p>
<p><code>plotly</code> has already been loaded for you, so there is no need to load it again.</p>
<p>After you create your graphic, be sure to explore the interactivity!</p>
</div>

```{r}
# edited/added
happy = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSD8eHTP8ohmRzaYNWI4EHx2AwhgRS_SZEPKjoulvvptc2yKXg0arsVsgkAX9c2Ef3t_v65Gl_ixq3P/pub?gid=543137381&single=true&output=csv")
```
<li>Create a scatterplot of <code>happiness</code> (on the y-axis) against <code>life.expectancy</code> (on the x-axis).</li>
<li>Use color to represent the <code>region</code>, and the size of the glyphs to represent <code>log.gdp</code>.</li>
```{r}
# Create a coded scatterplot of happiness vs. life.expectancy
happy %>%
  plot_ly(x = ~life.expectancy, y = ~happiness) %>%
  add_markers(color = ~region, size = ~log.gdp)
```

<p class="">Nice! Color and size are easy ways to add additional variables to your plots. However, we do need to exercise caution: notice that R gave a warning because there are 10 regions and the default color palette is for categorical variables with up to 8 levels. In the next lesson we'll see an alternative way to represent <code>region</code>.
</p>

##### Plotting symbols {.unnumbered}


<div class>
<p>Recall that <code>plotly</code> allows you to customize the plotting symbols used through the <code>symbols</code> argument to <code>add_markers()</code>. Both numeric and character specifications of <code>symbols</code> are permitted. For example, <code>100</code> denotes an open circle which can also be specified as <code>"circle-open"</code>. </p>
<p>To manually specify the scale for, say, three levels you can specify <code>symbols = c("circle", "triangle", "x")</code> to ensure that the groups are represented by circles, triangles, and x's, in that order.</p>
<p>Here's the <a href="https://plot.ly/r/reference/#scatter-marker-symbol">full list</a> of valid plotting symbols for your reference.</p>
<p>In this exercise, you'll change the plotting symbols for the income categories.</p>
<p><code>plotly</code> and the <code>happy</code> data set have already been loaded for you.</p>
</div>


<li>Change the plotting symbols for <code>income</code> categories according to the following scheme: </li>
<li>low: <code>"circle-open"</code>; lower-middle: <code>"square-open"</code>; upper-middle: <code>"star-open"</code>; high: <code>"x-thin-open"</code>
</li>
```{r}
# Fill in the specified plotting symbols
happy %>%
  plot_ly(x = ~life.expectancy, y = ~happiness) %>%
  add_markers(symbol = ~income, symbols = c("circle-open", "square-open", "star-open", "x-thin-open"))
```

<p class="">You got it! Using open plotting symbols (glyphs) can help reduce the effect of overlapping points, so choose your symbols wisely!
</p>

##### Polishing your graphics {.unnumbered}


<div class>
<p>The below code chunk produces an interactive plot of national happiness against an index for social support, where plotting symbols represent the income classification of the country. </p>
<pre><code>happy %&gt;%
  plot_ly(x = ~social.support, y = ~happiness,
  hoverinfo = "text",
  text = ~paste("Country: ", country)) %&gt;%
  add_markers(symbol = ~income, symbols = c("circle-open", "square-open", "star-open", "x-thin-open"))
</code></pre>
<p>Your task is to edit the hover information and axis labels so that your reader can more-easily digest the information.</p>
<p><code>plotly</code> and the <code>happy</code> data set have been loaded for you.</p>
</div>


<li>Add hover information for the <code>income</code> group, <code>happiness</code> score, and the <code>social.support</code> index.</li>
<li>Use <code>round(&lt;variable&gt;, 2)</code> to round all numeric variables to two decimal places in the hover info.</li>
<li>Change the x-axis label to <code>"Social support index"</code> and the y-axis label to <code>"National happiness score"</code>.</li>
```{r}
# Complete the following code to polish the plot
happy %>%
  plot_ly(x = ~social.support, y = ~happiness,
  hoverinfo = "text",
  text = ~paste("Country: ", country,
  "<br> Income: ", income,
  "<br> Happiness: ", round(happiness, 2),
  "<br> Social support: ", round(social.support, 2))) %>%
  add_markers(symbol = ~income, 
              symbols = c("circle-open", "square-open", "star-open", "x-thin-open")) %>%
  layout(xaxis = list(title = "Social support index"),
         yaxis = list(title = "National happiness score"))
```

<p class="">Great work! When you distribute interactive graphics providing clear labels, legends, and hover information is key.
</p>

#### Beyond Simple Interactivity {.unnumbered}



##### Bubble charts {.unnumbered}


<div class>
<p>To begin your exploration of the U.S. economic index data set, your task is to create a bubble chart of of the housing price index against real GDP. Further, you will add color to represent the region of the U.S. to explore potential regional clustering.</p>
<p>Throughout this exercise, you will also explore how changing the <code>sizemode</code> of the <code>marker</code> argument can help polish the plot.</p>
<p><code>plotly</code>, <code>dplyr</code>, and the <code>us_economy</code> data set have already been loaded.</p>
</div>

```{r}
# edited/added
us_economy = read.csv("https://assets.datacamp.com/production/repositories/2166/datasets/1367560ab66f0b7006da2075a5a97a99b5184bf7/state_economic_data.csv")
```
<li>Extract only the <code>2017</code> data.</li>

<li>Create a scatterplot of the housing price index (<code>house_price</code>) against GDP (<code>gdp</code>) for 2017. Use color to represent the <code>region</code> and make the size of the points proportional to the <code>population</code> of the state.</li>
```{r}
# Create a bubble chart of house_price vs. gdp
us_economy %>%
  filter(year == 2017) %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(size = ~population, color = ~region)
```

<li>Make the <code>population</code> proportional to the <code>"diameter"</code> of the points by changing the <code>sizemode</code>.</li>
```{r}
# Change the sizemode so that size refers to the diameter of the points
us_economy %>%
  filter(year == 2017) %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(size = ~population, 
              color = ~region, 
              marker = list(sizemode = "diameter"))
```

<p class="">Fantastic! Remember that if you want to decrease the size of the bubbles you can add the <code>sizeref</code> element to the marker list and set a value greater than 1. Now that you have mastered bubble charts, continue to the next chapter to see how you can animate them!
</p>

##### Many time series {.unnumbered}


<div class>
<p>How did the housing price index change from 2000 to 2017 in the United States? To begin answering this question, your task is to create a line chart representing the housing price index for each state over this time period.</p>
<p>Once you have created this plot, be sure to consider how easy or hard it is to interact with. Specifically, how easy is it to select a single state's trajectory?</p>
<p><code>plotly</code>, <code>dplyr</code>, and the <code>us_economy</code> data set have already been loaded.</p>
</div>


<li>Filter out the data from <code>2000</code> onward.</li>
<li>Next, group the data by <code>state</code>.</li>
<li>Finally, create a time series plot displaying how the housing price index (<code>house_price</code>) has changed over time (<code>year</code>).</li>
```{r}
# Create a line chart of house_price over time by state
us_economy %>%
  filter(year >= 2000) %>%
  group_by(state) %>%
  plot_ly(x = ~year, y = ~house_price) %>%
  add_lines()
```

<p class="">Terrific work! The <code>group_by()</code> function is very helpful when you are creating plotly charts, since it allows you to create groupings, much like the <code>group</code> aesthetic in ggplot2. Now that you have reviewed key concepts in plotly, let's create some animations!
</p>

### Animating graphics {.unnumbered}

<p class="chapter__description">
    In this chapter, you will learn how to implement keyframe animation in plotly. You will explore how to create animations, such as Hans Rosling's bubble charts, as well as cumulative animations, such as an animation of a stock's valuation over time.
  </p>

#### Animated graphics {.unnumbered}



##### What's the frame {.unnumbered}

<div class=""><p>Suppose you wish to create an animated scatterplot of the housing price index (<code>house_price</code>) against a state's real GDP (<code>gdp</code>) over the years. What variable should be mapped to the frame aesthetic?</p>
<p>Below are the first 10 rows of this data set.</p>
<pre><code># A tibble: 3,213 x 9
   state  year    gdp employment home_owners house_price population region division
   &lt;chr&gt; &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;      &lt;dbl&gt; &lt;chr&gt;  &lt;chr&gt;   
 1 AK     1997 42262.         NA        67.2        159.       609. West   Pacific 
 2 AK     1998 41157.         NA        66.3        164.       615. West   Pacific 
 3 AK     1999 40722.         NA        66.4        169.       620. West   Pacific 
 4 AK     2000 39517.         NA        66.4        172.       628. West   Pacific 
 5 AK     2001 40974.         NA        65.3        181.       634. West   Pacific 
 6 AK     2002 42881          NA        67.1        191.       642. West   Pacific 
 7 AK     2003 42150.     307300        70          200.       648. West   Pacific 
 8 AK     2004 43735.     304900        67.2        220.       659. West   Pacific 
 9 AK     2004 43735.     305100        67.2        220.       659. West   Pacific 
10 AK     2004 43735.     306000        67.2        220.       659. West   Pacific</code>
<code># ... with 3,203 more rows
</code></pre></div>

- [ ] <code>state</code>
- [x] <code>year</code>
- [ ] <code>gdp</code>
- [ ] <code>house_price</code>

<p class="dc-completion-pane__message dc-u-maxw-100pc">Correct! Here, you are creating a scatterplot for each <code>year</code>, so <code>year</code> is the key frames.</p>

##### Why do we need ids {.unnumbered}

<div class=""><p>Consider again the situation where you wish to create an animated scatterplot of the housing price index against a state's real GDP. Why should you specify <code>ids = ~state</code> when creating your animation?</p></div>

- [ ] There could be missing values in the data set.
- [ ] The order of the rows may not be consistent.
- [ ] To ensure that the points on the scatterplot don't appear to "reshuffle".
- [x] All of the above.

<p class="dc-completion-pane__message dc-u-maxw-100pc">Correct! Missing values and different row orderings could both cause the plot to "reshuffle", which is something we  want to avoid. Specifying the <code>ids</code> ensures <a href="https://bost.ocks.org/mike/constancy/" target="_blank" rel="noopener noreferrer">object constancy</a>.</p>

##### Animating a scatterplot {.unnumbered}


<div class>
<p>Your task is to create an animated <a href="https://datavizcatalogue.com/methods/bubble_chart.html">bubble chart</a> of the state-level housing price index against real GDP from 1997 to 2017. Can you see the impact of the recession on the housing market?</p>
<p>The <code>us_economy</code> data set and <code>plotly</code> are already loaded into your R session.</p>
</div>


<li>Create an animated scatterplot over the years with <code>gdp</code> on the x-axis and <code>house_price</code> on the y-axis.</li>
<li>Color the markers by <code>region</code>.</li>
<li>Make the <em>diameter</em> of the markers proportional to the <code>population</code>.</li>
```{r}
# Create an animated bubble chart of house_price against gdp
us_economy %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(size = ~population, color = ~region, 
              frame = ~year, ids = ~state,
              marker = list(sizemode = "diameter"))
```

<p class="">Nice! Bubble charts are often used to display either three or four variables on a single plot. Here, we display five variables through animation: <code>gdp</code>, <code>house_price</code>, <code>population</code>, <code>region</code>, and <code>year</code>. That said, more isn't always better, when designing a multivariate graphic be sure that the observer can perceive all of the variables!
</p>

##### Factors as frames {.unnumbered}


<div class>
<p>Time is not the only type of variable that can be used to specify the frames of an animation. You can also create an animation that cycles through subplots created by factors rather than using a grid layout.</p>
<p>In this exercise, you will adapt your answer from the previous question to create an animation that cycles through bubble charts for each region in 2017.</p>
<p>Note: The default settings for the animation make it go very quickly. In the next lesson, you'll learn how to adjust the speed. For now, you can use the slider bar to navigate between regions if you want to investigate the relationships.</p>
<p><code>plotly</code> and the <code>us_economy</code> data set have already been loaded.</p>
</div>
<div class="exercise--instructions__content">
<p>Complete the code to animate a bubble chart of <code>house_price</code> against <code>gdp</code> across regions of the U.S. Specifically,</p>

<li>filter out the data for <code>2017</code>,</li>
<li>and change the appropriate aesthetic to allow <code>region</code> to define each snapshot in the animation.</li>

</div>
```{r}
# Animate a bubble chart of house_price against gdp over region
us_economy %>%
  filter(year == 2017) %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(size = ~population, color = ~region, 
              frame = ~region, ids = ~state,
              marker = list(sizemode = "diameter"))
```

<p class="">Well done! You can use any variable in your data set to define the frame aesthetic. Typically, time variable and groupping factors make the most sense.
</p>

#### Polishing animations {.unnumbered}



##### Polishing your regional animation {.unnumbered}


<div class>
<p>In lesson 1, you created an animation that cycled through bubble charts of the housing price index against real GDP by region. In this exercise, your task is to polish that animation.</p>
<p>The animation you generated in the last chapter is stored as the object <code>ani</code>, and <code>plotly</code> has already been loaded for you.              </p>
<p>A full list of the <code>easing</code> options can be found in <a href="https://github.com/plotly/plotly.js/blob/master/src/plots/animation_attributes.js">here</a>. Notice that you can append <code>-in</code>, <code>-out</code>, and <code>-in-out</code> to the easing options outlined in the lesson to further customize the transitions between frames.</p>
</div>

```{r}
# edited/added
ani = us_economy %>%
  filter(year == 2017) %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(size = ~population, color = ~region, 
              frame = ~region, ids = ~state,
              marker = list(sizemode = "diameter"))
```
<li>Change the animation options so that each transition takes 300 milliseconds and each frame is displayed for 1700 milliseconds after the transition.</li>
<li>There are many different transitions supported by <code>plotly</code>. In the lesson, you saw an example of a <code>"bounce"</code> transition. Change the type of transition to <code>"elastic"</code>.</li>
<li>Remove the <code>prefix</code> from the slider text and change the font color to <code>"red"</code>.</li>
```{r}
# Adjust the frame and transition
# Change the type of transition to "elastic"
# Remove the prefix from the slider and change the font color to "red"
ani %>% 
   animation_opts(
     frame = 2000, 
     transition = 300, 
     easing = "elastic"
   ) %>%
   animation_slider(
     currentvalue = list(
       prefix = NULL, 
       font = list(color = "red")
     )
   )
```
<li>The x- and y-axes should both have polished labels. Use the <code>layout()</code> command to set the x-axis title to <code>"Real GDP (millions USD)"</code>, and to set the y-axis title to <code>"Housing price index"</code>.</li>
```{r}
# Polish the x- and y-axis titles
ani %>% 
   animation_opts(
     frame = 2000, 
     transition = 300, 
     easing = "elastic"
   ) %>%
   animation_slider(
     currentvalue = list(
       prefix = NULL, 
       font = list(color = "red")
     )
   ) %>%   
   layout(
     xaxis = list(title = "Real GDP (millions USD)"),
     yaxis = list(title = "Housing price index")
   )
```

<p class="">Great work! It's important to polish any graphic (static, interactive or dynamic) that you plan to distribute so that your reader knows exactly what you want them to see. Clarity will help the reader focus on the story you're telling!
</p>

##### Polishing your HPI animation {.unnumbered}


<div class><p>In this exercise, you will polish the bubble chart of housing price index against real GDP that you created in the last lesson.</p></div>


<li>Set the x-axis title to <code>"Real GDP (millions USD)"</code>, the y-axis title to <code>"Housing price index"</code>, and apply a log transformation to the x-axis.</li>
```{r}
# Polish the axis titles and log-transform the x-axis
us_economy %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(
    size = ~population, color = ~region, 
    frame = ~year, ids = ~state,
    marker = list(sizemode = "diameter")
  ) %>%
  layout(
    xaxis = list(title = "Real GDP (millions USD)", type = "log"),
    yaxis = list(title = "Housing price index")
  )
```
<li>Reduce the size of the bubble by setting <code>sizeref</code> to 3. (Recall that values larger than 1 result in smaller points while values smaller than 1 result in larger points.)</li>
```{r}
# Reduce the bubble size
us_economy %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(
    size = ~population, color = ~region, 
    frame = ~year, ids = ~state,
    marker = list(sizemode = "diameter", sizeref = 3)
  ) %>%
  layout(
    xaxis = list(title = "Real GDP (millions USD)", type = "log"),
    yaxis = list(title = "Housing price index")
  )
```
<li>Change the hover info so that it prints the state name by adding <code>hoverinfo</code> and <code>text</code> arguments to the <code>plot_ly()</code> command.</li>
```{r}
# Map state names to the hover info text
us_economy %>%
  plot_ly(
    x = ~gdp, y = ~house_price,
    hoverinfo = "text", text = ~state
  ) %>%
  add_markers(
    size = ~population, color = ~region, 
    frame = ~year, ids = ~state,
    marker = list(sizemode = "diameter", sizeref = 3)
  ) %>%
  layout(
    xaxis = list(title = "Real GDP (millions USD)", type = "log"),
    yaxis = list(title = "Housing price index")
  )
```

<p class="">Outstanding! Notice how much easier it is to interpret the animation now that you have rescaled the points and added color for the regions. For example, the Midwestern and Southern states no longer are severely overplotted, allowing us to see a more-pronounced rise and fall of the HPI in the South and the Midwest.
</p>

#### Layering in plotly {.unnumbered}



##### Adding background text {.unnumbered}


<div class><p>In the previous lesson, you polished your animated bubble chart of housing price index against real GDP. In this exercise, you will continue to polish this graphic by displaying the year in the background of the animation.</p></div>


<li>Add the year as background text. You should center the text at the point (<code>200000</code>, <code>450</code>), set the font color to <code>gray80</code>, and set the font size to <code>150</code>.</li>
<li>Use <code>animation_slider()</code> to hide the slider.</li>
```{r}
# Add the year as background text and remove the slider
us_economy %>%
  plot_ly(x = ~gdp, y = ~house_price, hoverinfo = "text", text = ~state) %>%
  add_text(x = 200000, y = 450, text = ~year, frame = ~year,
           textfont = list(color = toRGB("gray80"), size = 150)) %>%
  add_markers(size = ~population, color = ~region, 
              frame = ~year, ids = ~state,
              marker = list(sizemode = "diameter", sizeref = 3)) %>%
  layout(xaxis = list(title = "Real GDP (millions USD)", type = "log"),
         yaxis = list(title = "Housing price index")) %>%
  animation_slider(hide = TRUE)
```

<p class="">Well done! Now you don't have to look away from the data to see the year. Did you notice the 2004 that flew into the frame? There's obviously an inconsistency in the data, but setting <code>id = ~1</code> will achieve object constancy.
</p>

##### Plotting the baseline {.unnumbered}


<div class><p>You can use different data sets for different layers in <code>plotly</code>, just like you can in <code>ggplot2</code>. This is a useful strategy when you want to display a baseline time point (or group) in an animation. In this exercise, your task is to create an animated scatterplot of housing price index against real GDP, keeping the 1997 data points in the background.</p></div>


<li>Add static points representing the data from 1997 (found in <code>us1997</code>) as the first layer. Set the <code>color</code> of these points to <code>"gray60"</code> and the <code>opacity</code> to <code>0.5</code>.</li>
<li>Add a second trace to create an animated scatterplot over time (<code>year</code>) using the entire <code>us_economy</code> data frame. Remember that each point represents a <code>state</code> in any given <code>year</code>
</li>
```{r}
# extract the 1997 data
us1997 <- us_economy %>%
  filter(year == 1997)

# create an animated scatterplot with baseline from 1997
us_economy %>%
  plot_ly(x = ~gdp, y = ~house_price) %>%
  add_markers(data = us1997, marker = list(color = toRGB("gray60"), opacity = 0.5)) %>%
  add_markers(frame = ~year, ids = ~state, data = us_economy, showlegend = FALSE, alpha = 0.5) %>%
  layout(xaxis = list(type = "log"))
```

<p class="">Keep up the good work! Notice how adding the gray points provides a visual cue for how much the housing price index and real GDP have changed since 1997. In the next lesson, you'll see another strategy to add persistent information to a plot using cumulative animations.
</p>

#### Cumulative animations {.unnumbered}



##### How many rows? {.unnumbered}

<div class=""><p>Below is a small data set of monthly copper prices in 2006. Suppose that you wish to create a cumulative animation of these copper prices by month. How many rows are needed to create the frame for July (<code>Jul</code>)? </p>
<pre><code># A tibble: 12 x 4
   price month   day  year
 * &lt;dbl&gt; &lt;ord&gt; &lt;int&gt; &lt;dbl&gt;
 1 2678. Jan       1  2006
 2 2852. Jan      31  2006
 3 2927. Mar       2  2006
 4 3611. Apr       2  2006
 5 4306  May       2  2006
 6 3898. Jun       2  2006
 7 4170. Jul       2  2006
 8 4060. Aug       1  2006
 9 4033. Sep       1  2006
10 3999. Oct       1  2006
11 3676. Nov       1  2006
12 3436. Dec       1  2006
</code></pre></div>

- [ ] 1 row
- [x] 7 rows
- [ ] 12 rows
- [ ] 78 rows

<p class="dc-completion-pane__message dc-u-maxw-100pc">Correct! There are 7 data points necessary to plot the frame for July, since we wish to plot the current and past values.</p>

##### Median life expectancies {.unnumbered}


<div class>
<p>In the next exercise, you will create a cumulative time series of the median housing price index in each region. In order to do this, you must first calculate the median housing price index in each year for each region.</p>
<p>Use the <code>dplyr</code> package to complete this task.</p>
</div>

```{r}
# edited/added
library(tidyverse)
```
<li>Find the median housing price index (<code>house_price</code>) for each <code>region</code> within each <code>year</code> using <code>group_by()</code> and <code>summarize()</code>. </li>
<li>Name the new variable <code>median_hpi</code>.</li>
```{r}
# dplyr has already been loaded

# Find median life HPI for each region in each year
us_economy %>%
  group_by(region, year) %>%
  summarize(median_hpi = median(house_price))
```

<p class="">Well done! Data wrangling is essential to visualization, so be sure to consistently review the data verbs provided by <code>dplyr</code>.
</p>

##### Animating median life expectancies {.unnumbered}


<div class>
<p>The data frame of median HPI for region in each year you created in the previous exercise is stored as the object <code>med_hpi</code>. </p>
<p>In this exercise, you will work through the steps to create a cumulative time series animation displaying how the median HPI for each region has changed over time.</p>
<p>Note that <code>plotly</code>, <code>dplyr</code>, and <code>purrr</code> have been loaded for you.</p>
</div>

```{r}
# edited/added
med_hpi = us_economy %>%
  group_by(region, year) %>%
  summarize(median_hpi = median(house_price))
```
<li>Split the <code>med_lifex</code> data frame by <code>year</code>.</li>
<li>Create a list of cumulative data frames for each year by accumulating the data frames (i.e. recursively row binding the data frames) in the list created by <code>split()</code>.</li>
<li>Assign the names <code>1997:2017</code> to the list of data frames using <code>set_names()</code>.</li>
<li>Bind the list of data frames into a single data frame. Be sure to add a <code>frame</code> column specifying an id corresponding to each data frame in the list.</li>
```{r}
# Split the med_lifex data frame by year
# Create cumulative data frames for each year
# Set the names of the list, then bind the elements into rows of a data frame
med_hpi %>%
  split(.$year) %>%
  accumulate(~bind_rows(.x, .y)) %>%
  set_names(1997:2017) %>%
  bind_rows(.id = "frame")
```


<li>Animate the cumulative time series of median HPI (<code>median_hpi</code>) over time (<code>year</code>). Be sure to map the <code>region</code> to the <code>color</code> of the lines.</li>
```{r}
# Animate the cumulative time series of median HPI over time
med_hpi %>%
  split(.$year) %>%
  accumulate(~bind_rows(.x, .y)) %>%
  set_names(1997:2017) %>%
  bind_rows(.id = "frame") %>%
  plot_ly(x = ~year, y = ~median_hpi, color = ~region) %>%
  add_lines(frame = ~frame)
```

<p class="">Terrific! Notice how a cumulative time series draws attention to how the data unfold rather than the overall trends. Here, we see that the West experienced the largest drop in HPI during the recession. 
Now that you are comfortable with animation in ploty, it's time to turn to linked brushing.
</p>

### Linking graphics {.unnumbered}

<p class="chapter__description">
    When you are exploring unexpected structure in your graphics, it's useful to have selections made on one chart update the other. For example, if you are exploring clusters observed on a scatterplot, it is useful to have the selected cluster update some chart of group membership, such as a jittered scatterplot or sets of bar charts. In this chapter, you will learn how to link your plotly charts to enable linked brushing. Along the way, you will also learn how to add dropdown menus, checkboxes, and sliders to your plotly charts, without the need for Shiny.
  </p>

#### Linking two charts {.unnumbered}



##### sharedData objects {.unnumbered}


<div class><p>In previous exercises, you worked with the <code>us_economy</code> data set, which consists of economic indices for each state in the U.S. along with Washington D.C. from 1997 to 2017. Before you can create linked views, you must first create a new <code>sharedData</code> object. Which of the following commands will create the <code>sharedData</code> object necessary for the linked brushing of individual points between two charts?</p></div>

- [ ] <code>as.SharedData(us_economy)</code>
- [ ] <code>SharedData(us_economy)</code>
- [x] <code>SharedData$new(us_economy)</code>
- [ ] <code>SharedData(us_economy, new = TRUE)</code>

<p class="">You got it! Now that you have constructed a new <code>SharedData</code> object, you're ready to create linked views.
</p>

##### Linking scatterplots {.unnumbered}


<div class><p>In this exercise, you'll use <code>plotly</code> and <code>crosstalk</code> to link a scatterplot of the U.S. Housing Price Index in 2017 (HPI) against the percentage of homeowners to a scatterplot of the  2017 HPI against the employment rate. Both packages have already been loaded, and the data are stored in <code>us2017</code>.</p></div>

```{r}
# edited/added
library(crosstalk)
us2017 = us_economy %>% filter(year == 2017)
```
<li>Create a new SharedData object from the <code>us2017</code> dataset. Store this object as <code>shared_us</code>.</li>
<li>Create a scatterplot of the HPI in 2017 (<code>house_price</code>) against the percentage of homeowners (<code>home_owners</code>). Store this plot as <code>p1</code>.</li>
<li>A scatterplot of the HPI against the employment rate is stored in <code>p2</code>. Create a row of linked scatterplots.</li>
```{r}
# Create a SharedData object from us2017
shared_us <- SharedData$new(us2017)

# Create a scatterplot of house_price vs. home_owners
p1 <- shared_us %>%
  plot_ly(x = ~home_owners, y = ~house_price) %>%
  add_markers()

# Scatterplot of house_price vs. employment rate
p2 <- shared_us %>%
  plot_ly(x = ~employment/population, y = ~house_price) %>%
  add_markers()
  
# Link p1 and p2
subplot(p1, p2)
```
<li>Start to polish the linked scatterplots you just created by: (i) adding titles to the x-axes, (ii) adding a shared title to the y-axes, and (iii) hiding the legend.</li>
```{r}
# Polish the linked scatterplots
subplot(p1, p2, titleX = TRUE, shareY = TRUE) %>% hide_legend()
```

<p class="">Good work! Now try clicking on points, and using the box- and lasso-selection tools to highlight points on either plot. Is that interaction reflected on the other plot? Does a double click deselect the points?
</p>

##### highlighting charts {.unnumbered}


<div class>
<p>As you were exploring the linked scatterplot in the previous exercise, you may have noticed that once you selected a point on the scatterplot, doubling clicking did not deselect the point. In this exercise, you will explore how to use the <code>highlight()</code> function to correct this issue, along with it's other options. </p>
<p>Your linked scatterplots from the previous exercise are stored in the <code>linked_plots</code> object.</p>
</div>

```{r}
# edited/added
linked_plots = subplot(p1, p2, titleX = TRUE, shareY = TRUE) %>% hide_legend()
```
<li>The <code>highlight()</code> function allows points to be deselected. Add <code>highlight()</code> to your plotting pipeline to allow a click to turn on highlighting, and a double click to turn off highlighting.</li>
```{r}
# Add a highlight layer
linked_plots %>% highlight()
```
<li>Change the selection event that turns <code>on</code> highlighting to enable linked brushing using either box selection or lasso selection.</li>
```{r}
# Enable linked brushing
linked_plots %>% highlight(on = "plotly_selected")
```
<li>You can also enable linked brushing using the hover tool. To do this, specify that highlighting should be turned <code>on</code> by the <code>"plotly_hover"</code> tool.</li>
```{r}
# Enable hover highlighting
linked_plots %>% highlight(on = "plotly_hover")
```

<p class="">Well done! Linked brushing is a fantastic tool for uncovering clusters and unusual features, and visualizing how they appear across different orientations of your data set.
</p>

#### Brushing groups {.unnumbered}



##### Highlighting time series data {.unnumbered}


<div class>
<p>How did the Housing Price Index (HPI) change from 2000 to 2017 in the United States? In chapter 1 you created a basic time series plot that could start your investigation, but the inability to highlight an individual states' data was limiting. In this exercise, your task is to enable highlighting by state and investigate which states experienced the largest changes in HPI after the recession that started in December 2007. </p>
<p><code>plotly</code> and <code>crosstalk</code> have already been loaded, and the code used to previously create the time series plot is shown.</p>
</div>


<li>Create a <code>SharedData</code> object to enable the selection of an individual states' data.</li>
<li>Complete the plotting pipeline to create a time series plot of <code>house_price</code> against <code>year</code> by <code>state</code>.</li>
```{r}
# Create a shared data object keyed by individual states
state_data <- us_economy %>%
  SharedData$new(key = ~state)

# Using the shared data, plot house price vs. year
state_data %>%
  plot_ly(x = ~year, y = ~house_price) %>%
  # Group by state
  group_by(state) %>%
  # Add lines
  add_lines()
```

<p class="">Nice work! The ability to highlight an individual time series enables comparisons from that state to the whole. For example, it's easier to see that Nevada's (NV) housing prices took a huge dip during the recession, falling below the other states. What other states stand out?
</p>

##### Linking a dotplot and a time series plot {.unnumbered}


<div class>
<p>Did each region experience a similar downturn in HPI during the "Great Recession"? To start this investigation, link your time series plot from the previous exercise to a dotplot of the average HPI value by region in 2017. </p>
<p>The data are stored in <code>us_economy</code>, and <code>plotly</code> and <code>crosstalk</code> have been loaded for you.</p>
</div>


<li>Create a <code>SharedData</code> object allowing for selection by <code>region</code> and store it in the <code>shared_region</code> object.</li>
```{r}
# Create a shared data object keyed by region
shared_region <- SharedData$new(us_economy, key = ~region)
```
<li>Using your new <code>shared_region</code> object, <code>filter</code> out rows for <code>2017</code> group the data by <code>region</code>, calculate the average HPI (<code>house_price</code>) by <code>region</code>, and create a dotplot of these average by <code>region</code>.</li>
```{r}
# Create a dotplot of avg house_price by region in 2017
dp_chart <- shared_region %>%
  plot_ly() %>%
  filter(year == 2017) %>%
  group_by(region) %>%
  summarize(avg.hpi = mean(house_price, na.rm = TRUE)) %>%
  add_markers(x = ~avg.hpi, y = ~region)
```
<li>The adapted code for your time series chart is stored in the <code>ts_chart</code> object. Link <code>dp_chart</code> and <code>ts_chart</code> in a single row.</li>
```{r}
# Code for time series plot
ts_chart <- shared_region %>%
  plot_ly(x = ~year, y = ~house_price) %>%
  group_by(state) %>%
  add_lines()
  
# Link dp_chart and ts_chart
subplot(dp_chart, ts_chart)
```

<p class="">Nicely done! Notice how easy it is to call out a group when selecting from an aggregated chart. Additionally, by adding summary statistics you are helping the viewer (or yourself) identify <em>why</em> a group might be interesting.
</p>

##### Linking a bar chart to a scatterplot {.unnumbered}


<div class>
<p>In the lesson, you saw how to link a dotplot of summary statistics to a scatterplot, but you can link other types of charts in a similar way. In this exercise, you will link a bar chart to a bubble chart.</p>
<p>The data are stored in <code>us2017</code>, and <code>plotly</code> and <code>crosstalk</code> have been loaded for you.</p>
</div>

```{r}
# edited/added
us2017 = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSD8eHTP8ohmRzaYNWI4EHx2AwhgRS_SZEPKjoulvvptc2yKXg0arsVsgkAX9c2Ef3t_v65Gl_ixq3P/pub?gid=1730872968&single=true&output=csv") %>%
  group_by(division) %>%
  mutate(n = n())
```
<li>Create a <code>SharedData</code> object allowing for selection by <code>division</code> (i.e. subregion). Store this in the <code>shared_div</code> object.</li>

<li>Using <code>shared_div</code>, <code>count()</code> the number of cases per <code>division</code> and then create a bar chart of <code>division</code>. Store this chart in the <code>bc</code> object.</li>

<li>A bubble chart of home price index against homeownership is stored in the <code>bubble</code> object. Link <code>bc</code> and <code>bubble</code> in a single row.</li>

<li>Remove the legend from your linked graphic.</li>
```{r}
# Create a shared data object keyed by division
shared_div <- SharedData$new(us2017, key = ~division)

# Create a bar chart for division
bc <- shared_div %>%
  plot_ly() %>% # edited/added
  add_bars(x = ~division, y = ~n) %>%
  layout(barmode = "overlay")

# Bubble chart
bubble <- shared_div %>%
  plot_ly(x = ~home_owners, y = ~house_price, hoverinfo = "text", text = ~state) %>%
  add_markers(size = ~population, marker = list(sizemode = "diameter"))

# Link bc and bubble
subplot(bc, bubble)

# Remove the legend
subplot(bc, bubble) %>% hide_legend()
```

<p class="">Fantastic! While we didn't take the time to reorder the bars of the bar chart, etc., be sure to review how to fully polish your plotly graphics for maximum impact!
</p>

#### Selection strategies {.unnumbered}



##### Searching for clusters {.unnumbered}


<div class>
<p>Persistent selection is a great way to explore potential clusters in your data set, especially when paired with a color selector gadget. In this exercise, your task is to use persistent selection, hover selection, and color to explore potential clusters in scatterplots of 2017 HPI against the percentage of home ownership and the employment rate in a state.</p>
<p><code>plotly</code> and <code>crosstalk</code> have already been loaded for you, and the linked scatterplots are stored in the <code>linked_plots</code> object.</p>
</div>


<li>Use <code>highlight()</code> to (i) enable <code>persistent</code> selection, (ii) enable hover selection, and (iii) add a color selector widget.</li>
```{r}
# Enable persistent hover selection and a color selector 
linked_plots %>%
  highlight(persistent = TRUE, on = "plotly_hover", dynamic = TRUE)
```

<p class="">Fantastic! Now try to highlight two 'clusters' of observations using different colors. Did it help you see anything? Remember, don't worry about the message recommending that you set <code>persistent</code> to <code>FALSE</code>, in some cases it's best to be explicit rather than relying on another interaction (i.e. The shift key), so it's good to know how to use this option.
</p>

##### Adding dropdown menus {.unnumbered}


<div class>
<p>Indirect selection is a powerful tool that can facilitate exploration when overplotting is present. In the lesson, you saw this with overlaid time series plots. In this exercise, you will consider how indirect selection can help you "call out" specific points on a scatterplot.</p>
<p><code>plotly</code> and <code>crosstalk</code> have already been loaded for you.</p>
</div>


<li>Create a <code>SharedData</code> object and add a drop-down menu, titled <code>"Select a state"</code>, to enable indirect selection by state.</li>
```{r}
# Create a shared data object keyed by state
state_data <- SharedData$new(us2017, key = ~state, group = "Select state")

# Enable indirect selection by state
state_data %>%
  plot_ly(x = ~home_owners, y = ~house_price, hoverinfo = "text", text = ~state) %>%
  add_markers(size = ~population, marker = list(sizemode = "diameter")) %>%
  highlight(selectize = TRUE)
```

<li>Create a <code>SharedData</code> object and add a drop-down menu, titled <code>"Select a region"</code>, to enable indirect selection by region.</li>
```{r}
# Create a shared data object keyed by region
region_data <- SharedData$new(us2017, key = ~region, group = "Select a region")

# Enable indirect selection by region
region_data %>%
  plot_ly(x = ~home_owners, y = ~house_price, hoverinfo = "text", text = ~state) %>%
  add_markers(size = ~population, marker = list(sizemode = "diameter")) %>%
  highlight(selectize = TRUE)
```

<p class="">Great work! Adding a selectize.js widget allows you to quickly highlight specific observations/groups of interest without 'hunting' for them on the chart.
</p>

#### Making shinier charts {.unnumbered}

##### Arranging views with bscols {.unnumbered}

<div class>
<p>The <code>bscols()</code> function provides a flexible framework to combine HTML widgets, like plotly charts, using the Bootstrap column layout. Recall that in this system, there are 12 columns to distribute content over. Before adding different selectors, it's important to understand how to arrange content created using <code>bscols()</code>.</p>
<p><code>plotly</code> and <code>crosstalk</code> have been loaded for you, and the object <code>p97</code>, <code>p07</code>, and <code>p17</code> are scatterplots of HPI against the percentage of homeowners in each state for the years 1997, 2007, and 2017, respectively.</p>
</div>

<li>Use <code>bscols()</code> to arrange <code>p97</code>, <code>p07</code>, and <code>p17</code> in a single row.</li>
<li>Specify that <code>p97</code>, <code>p07</code>, and <code>p17</code> should have column <code>widths</code> <code>6</code>, <code>3</code>, and <code>3</code>, respectively.</li>
<li>Use <code>bscols()</code> to arrange <code>p97</code>, <code>p07</code>, and <code>p17</code> in a single row. Specify that <code>p07</code> should span <code>5</code> columns.</li>
<li>Arrange <code>p97</code> in the left column, and <code>p07</code> and <code>p17</code> in the right column.</li>

<div>
```{r}
# edited/added
us1997 = us_economy %>% filter(year == 1997)
us2007 = us_economy %>% filter(year == 2007)
us2017 = us_economy %>% filter(year == 2017)

p97 <- SharedData$new(us1997, key = ~region) %>%
  plot_ly(x = ~home_owners, y = ~house_price)
p07 <- SharedData$new(us2007, key = ~region) %>%
  plot_ly(x = ~home_owners, y = ~house_price)
p17 <- SharedData$new(us2017, key = ~region) %>%
  plot_ly(x = ~home_owners, y = ~house_price)

# Create a row of subplots containing p97, p07, and p17
subplot(p97, p07, p17)

# Create a row of subplots containing p97, p07, and p17 with widths 6, 3, 3
#subplot(widths = c(6, 3, 3), p97, p07, p17)

# Specify that p07 should span 5 columns
#bscols(widths = c(NA, 5, NA), p97, p07, p17)

# Stack p07 and p17 in the right column
#bscols(p97, list(p07, p17))
```
</div>

<p class="">Great! <code>bscols()</code> makes it easy to combine plotly charts and other HTML widgets. To control the height of a <code>plotly</code> chart, add the <code>height</code> argument (in pixels) to the <code>plot_ly()</code> command.
</p>

##### Adding checkboxes {.unnumbered}

<div class>
<p>Adding checkbox filters allows you to quickly "call out" a group, or set of groups, which is particularly useful when exploring how associations change between groups.</p>
<p>In this exercise, your task is to add a checkbox filter for the region to a scatterplot of the housing price index against homeownership in 2017.</p>
<p><code>plotly</code> and <code>crosstalk</code> have already been loaded for you, and the data are stored in <code>us2017</code>.</p>
</div>

<li>Add a checkbox filter for <code>region</code> to the left of the scatterplot stored in <code>p17</code>.</li>
<li>Restrict the width of the checkboxes to <code>3</code> columns, and allow the plot to span the remainder of the columns.</li>

<div>
```{r}
# shared data object
shared_us <- SharedData$new(us2017, key = ~region)

# scatterplot of housing price index against homeownership
p17 <- shared_us %>%
  plot_ly(x = ~home_owners, y = ~house_price, color = ~region, height = 400) %>%
  add_markers()

# add a column of checkboxes for region to the left of the plot
# bscols(widths = c(3, NA),
#   filter_checkbox(id = "region", label = "Region", sharedData = shared_us, group = ~region),
#   p17
# )
```
</div>

<p class="">Terrific! Here, the checkboxes allow us to quickly isolate the points for a specific region. How do the checkboxes differ from what happens when you click on a region in the legend?
</p>

##### Adding a slider {.unnumbered}


<div class>
<p>A slider filter allows you to easily update the data values plotted by restricting a numeric variable to a specific range. In this exercise, your task is to include two slider filters for the scatterplot of the housing price index against homeownership in 2017: one for each axis.</p>
<p><code>plotly</code> and <code>crosstalk</code> have already been loaded for you, and the data are stored in <code>us2017</code>.</p>
<p>Note: You may need to scroll down on or pop out the HTML Viewer to see the sliders.</p>
</div>

<li>Place two slider filters below the scatterplot stored in <code>p17</code>. The first slider should correspond to the housing price index (<code>house_price</code>), and the second slider should correspond to the percentage of home ownership (<code>home_owners</code>).</li>
<li>Add slider labels that match the axis titles in <code>p17</code>, <code>"HPI"</code> and <code>"Home ownership (%)"</code>.</li>

<div>
```{r}
# edited/added
shared_us <- SharedData$new(us2017)
p17 <- shared_us %>%
  plot_ly(x = ~home_owners, y = ~house_price,
          color = ~region, height = 400) %>%
  add_markers() %>%
  layout(xaxis = list(title = "Home ownership (%)"),
         yaxis = list(title = "HPI"))

# add a slider filter for each axis below the scatterplot
# bscols(
#   list(p17,
#        filter_slider(id = "price", label = "HPI", sharedData = shared_us, column = ~house_price),
#        filter_slider(id = "owners", label = "Home ownership (%)", sharedData = shared_us, column = ~home_owners)
#   )
# )
```
</div>

<p class="">Terrific! Think carefully about whether you want to fix the range of your axes when using sliders to filter observations. If you want to zero in on a specific region, or delete outliers, then there is no need to fix the range.
</p>


### Case Study: Space launches {.unnumbered}

<p class="chapter__description">
    In the final chapter, you will use your expanded plotly toolkit to explore orbital space launches between 1957 and 2018. Along the way, you'll learn how to wrangle data to enable cumulative animations without common starting points, and hone your understanding of the crosstalk package.
  </p>

#### The space launches data {.unnumbered}



##### Launches over time {.unnumbered}


<div class>
<p>In the following exercises, you will explore the launches data, which attempts to list all orbital launches (both successful and unsuccessful). Before creating animations or linked views, you'll explore how the number of launches and the sponsoring agencies have evolved over time. In this exercise, your task is to visualize the evolution of launches over time three ways. Be sure to think about the relative strengths and weaknesses of each chart type.</p>
<p>The <code>launches</code> data frame, and the <code>plotly</code> and <code>dplyr</code> packages are already loaded.</p>
</div>

```{r}
# edited/added
launches = read.csv("https://assets.datacamp.com/production/repositories/2166/datasets/c09b75e6d503e5253c80bcfcdfb8f95a606d9793/launches.csv")
```
<li>Construct a time series plot using lines to connect the number of launches (<code>n</code>) over time (<code>launch_year</code>).</li>
```{r}
# table of launches by year
launches_by_year <- launches %>%
  count(launch_year)

# create a line chart of launches over time
launches_by_year %>%
  plot_ly(x = ~launch_year, y = ~n) %>%
  add_lines() %>%
  layout(
    xaxis = list(title = "Year"), 
    yaxis = list(title = "Launches")
  )
```




<li>Create a filled area chart by adding the <code>fill = 'tozeroy'</code> argument to the line chart you just created.</li>
```{r}
# create a filled area chart of launches over time
launches_by_year %>%
  plot_ly(x = ~launch_year, y = ~n) %>%
  add_lines(fill = 'tozeroy') %>%
  layout(
    xaxis = list(title = "Year"), 
    yaxis = list(title = "Launches")
  )
```



<li>Create a bar chart to represent the number of launches (<code>n</code>) over time (<code>launch_year</code>).</li>
```{r}
# create a bar chart of launches over time
launches_by_year %>%
  plot_ly(x = ~launch_year, y = ~n) %>%
  add_bars() %>%
  layout(
    xaxis = list(title = "Year"), 
    yaxis = list(title = "Launches")
  )
```

<p class="">Well done! Which chart design do you prefer? The traditional line chart minimizes the data-to-ink ratio, and is typically preferred because of the minimalist style. If you choose to use one of the other charts, be sure to justify the use of extra 'ink'.
</p>

##### Space race timeline {.unnumbered}


<div class>
<p>The "first" space race began as the United States and the Soviet Union tried to become the global force in spaceflight. This race peaked on July 20, 1969, when Apollo 11, a crewed spacecraft, landed on the moon. In this exercise, your task is to create a time series plot summarizing the first space race: the race for spaceflight superiority by countries.</p>
<p>The <code>plotly</code>, <code>crosstalk</code>, and <code>dplyr</code> packages are already loaded.</p>
</div>


<li>Create a new <code>SharedData</code> object from the <code>state_launches</code> data frame.</li>
<li>Create a line chart displaying the number of launches by year (<code>launch_year</code>) for each state (<code>state_code</code>). </li>
<li>Plot each line in a different color.</li>
<li>Enable selection (i.e. highlighting) of an individual state.</li>
```{r}
# table of launches by year
state_launches <- launches %>% 
  filter(agency_type == "state") %>% 
  count(launch_year, state_code)

# create a ShareData object for plotting
shared_launches <- state_launches %>% SharedData$new(key = ~state_code)

# Create a line chart for launches by state, with highlighting
shared_launches %>%
  plot_ly(x = ~launch_year, y = ~n, color = ~state_code) %>%
  add_lines() %>%
  highlight()
```

<p class="">Great work! Looking at this plot we find that the Soviet Union (Russia) launched far more space vehicles in the 1970s and 1980s. The article in The Economist points out that this is due to unreliable satelites that needed to be replaced often. Regardless, by 2000 both the U.S. And Russian governments were conducting a fraction of the launches they did at the height of the space race.
</p>

##### State vs. private launches {.unnumbered}


<div class>
<p>Based on the previous graphic, it seems that, aside from China, there has been a decline in launches. Is this true? Or has the space race reached the private market? In this exercise, your task is to explore this question by comparing the number of launches by states and private companies over time.</p>
<p>The <code>plotly</code>, <code>crosstalk</code>, and <code>dplyr</code> packages are already loaded.</p>
</div>


<li>Create a new <code>SharedData</code> object from the <code>launches_by_year</code> data frame.</li>
<li>Create a line chart to represent the number of launches over time (<code>launch_year</code>) by <code>agency_type</code>. Use color to represent <code>agency_type</code>.</li>
<li>Enable selection (i.e. highlighting) of an <code>agency_type</code>.</li>
```{r}
# table of launches by year and agency type
launches_by_year <- launches %>% count(launch_year, agency_type)

# create a ShareData object for plotting
shared_launches <- launches_by_year %>% SharedData$new(key = ~agency_type)

# create a line chart displaying launches by agency type, with highlighting
shared_launches %>%
  plot_ly(x = ~launch_year, y = ~n, color = ~agency_type) %>%
  add_lines() %>%
  highlight()
```

<p class="">Fantastic! It's clear that private companies are accounting for more launches than the early days of the space race. To fully understand whether there has been a changing of the guard, we need to explore the breakdown of launches by state, since as we previously saw China is ramping up their space program.
</p>

#### Recap: Animation {.unnumbered}



##### Animating the space race {.unnumbered}


<div class>
<p>In lesson 1, you create static line charts to explore the space race. In this exercise, you will work through the steps to create an animated version of that chart.</p>
<p><code>plotly</code>, <code>dplyr</code>, <code>tidyr</code>, and <code>purrr</code> have been loaded for you.</p>
</div>


<li>Complete the <code>state_launches</code> data set so that each combination of <code>state_code</code> and <code>launch_year</code> is included. Use <code>0</code> to fill in any missing values for the number of launches (<code>n</code>).</li>


<li>Accumulate the launch data by <code>launch_year</code> to create a data set for your cumulative animation. There is no need to explicitly set the names of the list prior to binding the list into rows. Be sure add a column of identifiers named <code>frame</code>.</li>

<li>Create an animated line chart to visualize how the number of launches (<code>n</code>) for each state (<code>state_code</code>) has changed over the years (<code>launch_year</code>). Make sure that each state is plotted in a different color.</li>
```{r}
# Complete the state_launches data set
annual_launches <- state_launches %>%
  count(launch_year, state_code) %>%
  complete(state_code, launch_year, fill = list(n = 0))

# Create the cumulative data set
cumulative_launches <- annual_launches %>%
  split(f = .$launch_year) %>%
  accumulate(., ~bind_rows(.x, .y)) %>%
  bind_rows(.id = "frame")

# Create the cumulative animation
cumulative_launches %>%
  plot_ly(x = ~launch_year, y = ~n, color = ~state_code) %>%
  add_lines(frame = ~frame, ids = ~state_code)
```

<p class="">Excellent! Watching this animation you still focus on the competition between the U.S. And Soviet Union/Russia, but it also emphasizes the emergence of China in the race in the late 2000s.
</p>

##### Animating the private space race {.unnumbered}


<div class>
<p>In recent years the major players in spaceflight have shifted from government agencies to private companies. In this exercise, your task is to create an animation to explore the evolution of this "new" space race. The data set <code>private_launches</code> contains the variables:</p>

<li>
<code>tag</code> - launch ID</li>
<li>
<code>year</code> - launch year</li>
<li>
<code>agency_code</code> - agency abbreviation</li>
<li>
<code>agency_name</code> - agency name</li>
<li>
<code>agency_type</code> - an established <code>private</code> company or a <code>startup</code>
</li>
<li>
<code>category</code> - success (<code>O</code>) or failure (<code>F</code>) of the launch</li>

<p><code>plotly</code>, <code>dplyr</code>, <code>tidyr</code>, and <code>purrr</code> have been loaded for you.</p>
</div>

```{r}
# edited/added
private_launches = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSD8eHTP8ohmRzaYNWI4EHx2AwhgRS_SZEPKjoulvvptc2yKXg0arsVsgkAX9c2Ef3t_v65Gl_ixq3P/pub?gid=1078364219&single=true&output=csv")
```
<li>Complete the <code>private_launches</code> data set so that if an agency (<code>agency_name</code>) has <code>0</code> launches in a <code>year</code> this is explicitly stated.</li>

<li>Accumulate <code>annual_launches</code> by <code>year</code> to create a data set for your cumulative animation. There is no need to explicitly set the names of the list prior to binding to create the <code>frame</code> column in this example.</li>

<li>Create an animated line chart visualizing how the number of launches (<code>n</code>) for each agency (<code>agency_name</code>) has changed over the <code>year</code>s.</li>
```{r}
# Complete the private_launches data set
annual_launches <- private_launches %>%
  count(year, agency_name) %>%
  complete(agency_name, year, fill = list(n = 0))

# Create the cumulative data set
cumulative_launches <- annual_launches %>%
  split(f = .$year) %>%
  accumulate(., ~bind_rows(.x, .y)) %>%
  bind_rows(.id = "frame")

# Create the cumulative animation
cumulative_launches %>%
  plot_ly(x = ~year, y = ~n, color = ~agency_name) %>%
  add_lines(frame = ~frame, ids = ~agency_name)
```

<p class="">Excellent! It's clear that many of the U.S. Companies in the space race have only launched a few vehicles (i.e. They are not yet major players). Further, the animation shows SpaceX's recent ascent as the dominant force in private spaceflight.
</p>

#### Recap {.unnumbered}



##### Linking for group selection {.unnumbered}


<div class>
<p>Have the length and diameter of the launch vehicles changed over time? One way to answer this question is to create an animation. Another approach is to link a chart representing time to a chart displaying the length and diameter of the launch vehicles. In this exercise, you will link a bar chart representing the number of launches over the years to a scatterplot of diameter against height.</p>
<p><code>plotly</code>, <code>crosstalk</code>, <code>dplyr</code>, and the <code>lv</code> data set have been loaded for you.</p>
</div>

```{r}
# edited/added
lv = read.csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSD8eHTP8ohmRzaYNWI4EHx2AwhgRS_SZEPKjoulvvptc2yKXg0arsVsgkAX9c2Ef3t_v65Gl_ixq3P/pub?gid=383380028&single=true&output=csv")
lv[lv == "NA"] <- NA
lv = lv %>% group_by(launch_year) %>% mutate(n = n())
```
<li>Create a <code>SharedData</code> object allowing the <code>launch_year</code> to act as the <code>key</code>. Store this object in the <code>shared_year</code> object.</li>



<li>Create a bar chart displaying the number of launches (<code>n</code>) by <code>launch_year</code>. </li>
<li>Enable highlighting and adjust the <code>barmode</code> so that only a single bar for each year is displayed upon selection.</li>

<li>Create a scatterplot of launch vehicle <code>diameter</code> (y-axis) against <code>length</code> (x-axis). Be sure to enable highlighting.</li>

<li>Use the <code>bscols()</code> command to link the <code>bar</code> chart and <code>scatter</code>plot (in that order).</li>
```{r}
# Create a SharedData object allowing selection by year
shared_year <- SharedData$new(lv, key = ~launch_year)

# Create a bar chart of launches by year
bar <- shared_year %>%
  plot_ly(x = ~launch_year, y = ~n) %>%
  # edited/added
  add_bars() %>%
  layout(barmode = "overlay") %>%
  highlight()

# Create a scatterplot of diameter vs. length
scatter <- shared_year %>%
  plot_ly(x = ~length, y = ~diameter) %>%
  add_markers() %>%
  highlight()

# Use bscols to link the two charts
subplot(bar, scatter)
```

<p class="">You got it! Is there any trend in the length or diameter of the launch vehicles as time progresses? Try selecting the early years and comparing them to the later years.
</p>

##### Linked brushing {.unnumbered}


<div class>
<p>Linked brushing is a powerful tool to explore outliers and potential clusters. In this exercise, your task is to link a scatterplot of the diameter vs. length of launch vehicles to a scatterplot of total thrust vs. the payload capacity to low earth orbit (LEO). You'll restrict attention to launches since 2000.</p>
<p><code>plotly</code>, <code>crosstalk</code>, and the <code>lv2000</code> (a subset of the launch vehicle data set since 2000) have been loaded for you.</p>
</div>

```{r}
# edited/added
lv2000 = lv %>% filter(launch_year >= 2000)
```
<li>Create a <code>SharedData</code> object allowing the selection of individual observations in the <code>lv2000</code> data frame. Store this object as <code>shared_obs</code>.</li>

<li>Create a scatterplot of total thrust (<code>to_thrust</code>) against LEO capacity (<code>leo_capacity</code>).</li>



<li>A scatterplot of <code>diameter</code> against <code>length</code> has been added to the code chunk. </li>
<li>Use <code>subplot()</code> to link <code>p1</code> and <code>p2</code>. </li>
<li>Specify that highlighting/selection should turn <code>on</code> based on a selection and <code>off</code> based on a deselection, and hide the legend.</li>
```{r}
# Create a SharedData object allowing selection of observations
shared_obs <- SharedData$new(lv2000)

# Create a scatterplot of to_thrust against leo_capacity
p1 <- shared_obs %>%
  plot_ly(x = ~leo_capacity, y = ~to_thrust) %>%
  add_markers()

# Scatterplot of diameter vs. length
p2 <- shared_obs %>%
  plot_ly(x = ~length, y = ~diameter) %>%
  add_markers()

# Link p1 and p2
subplot(p1, p2) %>%
  highlight(on = "plotly_selected", off = "plotly_deselect") %>%
  hide_legend()
```

<p class="">Great work! Now that you have linked scatterplots, explore where unusual clusters/outliers on one chart fall on the other.
</p>

##### Linked views for summarization {.unnumbered}


<div class><p>Some traces compute statistical summaries in the background prior to plotting, such as histograms and boxplots. Consequently, if you link a boxplot to another chart, the boxplot will be updated based on the points selected. In this exercise, you will explore this behavior by linking your scatterplot of total thrust against LEO capacity to both a boxplot and a histogram.</p></div>


<li>Create a vertical boxplot of total thrust (<code>to_thrust</code>). Be sure to hide the legend and to enable linked brushing.</li>
```{r}
# SharedData object allowing selection of observations
shared_obs <- SharedData$new(lv2000)

# Scatterplot of to_thrust against leo_capacity
scatter <- shared_obs %>%
  plot_ly(x = ~leo_capacity, y = ~to_thrust) %>%
  add_markers()

# Create a boxplot of to_thrust
box <- shared_obs %>%
  plot_ly(y = ~to_thrust) %>%
  add_boxplot(name = "overall")

# Link the two plots
subplot(scatter, box) %>%
  hide_legend() %>%
  highlight(on = "plotly_selected")
```




<li>Create a histogram of total thrust (<code>to_thrust</code>). Be sure to hide the legend and to enable linked brushing.</li>
```{r}
# Create a histogram of to_thrust
histo <- shared_obs %>%
  plot_ly(x = ~to_thrust) %>%
  add_histogram(name = "overall")

# Link the two plots
subplot(scatter, histo) %>%
  hide_legend() %>%
  highlight(on = "plotly_selected")
```

<p class="">Well done! Notice that the linked histogram is redrawn such that there are two sets of barsâ€”selected and overallâ€”side-by-side. To plot the selected values on top of the overall histogram, specify <code>barmode = 'overlay'</code> in the <code>layout()</code>.
</p>

##### Adding a slider for time {.unnumbered}


<div class>
<p>In the previous lesson, you created an animation displaying the number of launches by each state over the years. A slider bar is an alternative to that animation that gives you full control over what portion of the story to investigate. For example, you can view it from beginning to end or focus only on the 1960s. In this exercise, your task is to add a slider bar below the line chart of state-based launches.</p>
<p><code>plotly</code>, <code>crosstalk</code>, <code>dplyr</code>, and the <code>state_launches</code> data set have been loaded for you.</p>
</div>


<li>Calculate the number of launches by <code>state_code</code> and <code>launch_year</code>, and convert this to a <code>SharedData</code> object. Store the result in <code>shared_launches</code>.</li>
<li>Using <code>shared_launches</code>, create a line chart displaying the the number of launches (<code>n</code>) by each state over time. Store this chart as <code>launch_ts</code>. Use color to represent the <code>state_code</code>.</li>
<li>Position a slider below the chart to filter the years displayed. Label this slider <code>"Year"</code>.</li>
```{r}
# Create a SharedData object containing the number of launches by year and state
shared_launches <- state_launches %>%
  count(launch_year, state_code) %>%
  SharedData$new()

# Create a line chart displaying the launches by state
launch_ts <- shared_launches %>%
  plot_ly(x = ~launch_year, y = ~n, color = ~state_code) %>%
  add_lines()  

# Add a slider below the chart to filter the years displayed
# bscols(list(launch_ts,
#     filter_slider(id = "time", label = "Year", 
#                   sharedData = shared_launches, column = ~launch_year)
# ))
```

<p class="">Fantastic! Be sure to explore this chart and think about when you might want this level of control and ability to focus on specific regions of a time series. If you want to 'replicate' the feel of the animation while retaining the control of the slider, then you can fix the range of the x-axis.
</p>

#### Wrap-up {.unnumbered}

##### Wrap-up {.unnumbered}

Congratulations - you've finished the course! Now that you've reached the end, you understand how to animate your plotly charts, to create linked views, and to add basic selector widgets to filter the dataset without shiny.

##### Chapter 1: plotly review {.unnumbered}

In chapter 1, you reviewed the fundamentals of plotly, including how to thoughtfully use color, size, and symbol to represent additional variables. You also reviewed how to polish your charts to add context for the reader.

##### Chapter 2: Animating your charts {.unnumbered}

In chapter 2, you learned how to animate your plotly charts. First, you learned about how keyframe animation is implemented in plotly using the frame aesthetic, and why the ids aesthetic is needed to ensure object constancy. Next, you learned how to adjust the animation options to polish the transitions and other behavior. Then, you learned how to layer elements in an animation to, for example, add background text or to display a baseline measurement. Finally, you learned how to wrangle your data to create cumulative animations, which are especially useful for visualizing time series data such as the space race or financial indicators.

##### Chapter 3: Linked views and shinier charts {.unnumbered}

In chapter 3, you learned how to use the crosstalk package with the highlight function to create SharedData objects that enable you to link your plotly charts, so that selections are reflected on all of your linked charts. Linked brushing is a powerful exploratory tool that help uncover clusters and outliers across multiple dimensions. You also learned how to implement different selection strategies using the highlight command and how to add basic inputs to facilitate filtering using the bscols function in crosstalk.

##### Chapter 4: Space launches case study {.unnumbered}

In this chapter, you reviewed the concepts from the first three chapters while exploring the space launches dataset. Along the way, you learned about the `complete` function in the tidyr package, allowing you to wrangle your dataset to allow the animation of multiple time series on a single chart.

##### Where to go from here {.unnumbered}

Youâ€™ve learned a lot, so where should you go from here to continue expanding your interactive graphics toolkit? The good news is that there are many fantastic options: If plotly is the only interactive plotting library that youâ€™re familiar with, then I encourage you to check out DataCampâ€™s courses on * leaflet * highcharter * trelliscope * or rbokeh If the idea of linked views and selector widgets grabbed your interest, then I encourage you to learn how to harness the power of shiny. * Carson Sievertâ€™s book, plotly for R, introduces the idea of linked views with shiny, but I would recommend learning the basics of shiny prior to jumping in. * Additionally, DataCamp has great courses on building web applications with shiny.

##### Thank you! {.unnumbered}

Thanks for taking this course with me, I hope that you've had as much fun as I have. Now go forth and link and animate your interactive graphics!